<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Voice Restaurant Booking — Final</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f6f8fb;
            margin: 0;
            color: #0b1220
        }

        .wrap {
            max-width: 900px;
            margin: 18px auto;
            padding: 16px
        }

        .card {
            background: #fff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(12, 20, 30, 0.06)
        }

        h1 {
            margin: 0 0 10px;
            font-size: 20px
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer
        }

        .btn-primary {
            background: #0f62fe;
            color: #fff
        }

        .btn-ghost {
            background: #eef4ff;
            color: #0f62fe;
            border: 1px solid #dbeafe
        }

        .status {
            color: #6b7280;
            margin-bottom: 10px;
            font-size: 14px
        }

        .transcript {
            background: #fbfdff;
            border: 1px solid #eef2f7;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 12px
        }

        .summary {
            background: #fafbff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #eef2f6
        }

        label {
            font-weight: 600;
            font-size: 13px
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e6eef6;
            margin-top: 6px
        }

        .row {
            display: flex;
            gap: 8px
        }

        .row>div {
            flex: 1
        }

        pre {
            white-space: pre-wrap;
            background: #f8fafc;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #eef2f6
        }

        .controls-right {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px
        }

        @media(max-width:880px) {
            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>Voice Restaurant Booking</h1>

            <div class="controls">
                <button id="startBtn" class="btn-primary">Start Voice Flow</button>
                <button id="stopBtn" class="btn-ghost" disabled>Stop</button>
                <button id="resetBtn" class="btn-ghost">Reset</button>

                <label style="display:flex;align-items:center;gap:8px;margin-left:auto">
                    Language
                    <select id="langSelect" style="margin-left:6px">
                        <option value="en-IN">English (en-IN)</option>
                        <option value="hi-IN">Hindi (hi-IN)</option>
                    </select>
                </label>
            </div>

            <div class="status" id="flowStatus">Idle — click Start Voice Flow</div>

            <div class="transcript" id="transcript">Transcript will show here.</div>

            <div class="grid">
                <div>
                    <div style="margin-bottom:8px"><label>Name</label>
                        <div id="val-customerName" style="margin-top:6px;color:#334155">—</div>
                    </div>
                    <div style="margin-bottom:8px"><label>Guests</label>
                        <div id="val-numberOfGuests" style="margin-top:6px;color:#334155">—</div>
                    </div>
                    <div style="margin-bottom:8px"><label>Date</label>
                        <div id="val-bookingDate" style="margin-top:6px;color:#334155">—</div>
                    </div>
                    <div style="margin-bottom:8px"><label>Time</label>
                        <div id="val-bookingTime" style="margin-top:6px;color:#334155">—</div>
                    </div>
                    <div style="margin-bottom:8px"><label>Cuisine</label>
                        <div id="val-cuisinePreference" style="margin-top:6px;color:#334155">—</div>
                    </div>
                    <div style="margin-bottom:8px"><label>Special requests</label>
                        <div id="val-specialRequests" style="margin-top:6px;color:#334155">—</div>
                    </div>
                </div>

                <div class="summary">
                    <h3 style="margin:0 0 8px">Summary (editable)</h3>
                    <label>Customer name</label>
                    <input id="edit-customerName" placeholder="Name" />

                    <div class="row" style="margin-top:8px">
                        <div>
                            <label>Guests</label>
                            <input id="edit-numberOfGuests" type="number" min="1" />
                        </div>
                        <div>
                            <label>Date (YYYY-MM-DD or 20 Aug)</label>
                            <input id="edit-bookingDate" placeholder="YYYY-MM-DD or 20 Aug" />
                        </div>
                        <div>
                            <label>Time (6:00 PM)</label>
                            <input id="edit-bookingTime" placeholder="6:00 PM or 18:00" />
                        </div>
                    </div>

                    <label style="margin-top:8px">Cuisine</label>
                    <input id="edit-cuisinePreference" />

                    <label style="margin-top:8px">Special requests</label>
                    <textarea id="edit-specialRequests" rows="2"></textarea>

                    <div class="controls-right">
                        <button id="applyEdit" class="btn-ghost">Apply Edits</button>
                        <button id="confirmBtn" class="btn-primary">Confirm & Preview</button>
                    </div>

                    <div id="previewArea" style="margin-top:10px;display:none">
                        <label>Preview response</label>
                        <pre id="previewJson"></pre>
                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                            <button id="createBtn" class="btn-primary">Create Booking</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* =========== Configuration =========== */
        const API_BASE = ''; // empty means relative to same origin (works if served by Express on port 4000). Use 'http://localhost:4000' if needed.
        const MAX_GUESTS = 30;

        /* =========== Small UI helpers =========== */
        function logStatus(msg) { document.getElementById('flowStatus').textContent = msg; }
        function setTranscript(txt) { document.getElementById('transcript').textContent = txt; }
        function setVal(id, txt) { document.getElementById('val-' + id).textContent = txt || '—'; }

        /* =========== Words -> number helpers =========== */
        function wordsToNumber(s) {
            if (!s) return null;
            s = String(s).toLowerCase().replace(/[-,]/g, ' ').replace(/\band\b/g, ' ');
            const small = { zero: 0, one: 1, two: 2, three: 3, four: 4, five: 5, six: 6, seven: 7, eight: 8, nine: 9, ten: 10, eleven: 11, twelve: 12, thirteen: 13, fourteen: 14, fifteen: 15, sixteen: 16, seventeen: 17, eighteen: 18, nineteen: 19 };
            const tens = { twenty: 20, thirty: 30, forty: 40, fifty: 50, sixty: 60, seventy: 70, eighty: 80, ninety: 90 };
            const parts = s.split(/\s+/).filter(Boolean);
            let total = 0, cur = 0;
            for (const p of parts) {
                if (small[p] != null) cur += small[p];
                else if (tens[p] != null) cur += tens[p];
                else if (!isNaN(parseInt(p))) cur += parseInt(p);
            }
            const out = total + cur;
            return out === 0 ? null : out;
        }
        function extractNumberFromText(text) {
            if (!text) return null;
            const d = text.match(/(\d{1,3})/);
            if (d) return parseInt(d[1], 10);
            const wm = text.match(/((?:zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|hundred|\s|-)+)/i);
            if (wm) return wordsToNumber(wm[1]);
            return null;
        }

        /* =========== Date & Time parsing (improved) =========== */
        function parseDateSmart(text) {
            if (!text) return null;
            text = String(text).trim();

            // explicit 4-digit year?
            const yearMatch = text.match(/\b(19|20)\d{2}\b/);
            const explicitYear = yearMatch ? parseInt(yearMatch[0], 10) : null;

            // try native parse first (ISO or "2025-08-20")
            const iso = Date.parse(text);
            if (!isNaN(iso)) {
                const d = new Date(iso);
                if (explicitYear && d.getFullYear() !== explicitYear) d.setFullYear(explicitYear);
                return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0, 0); // midday local
            }

            // textual day+month patterns
            const months = {
                jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11,
                january: 0, february: 1, march: 2, april: 3, may: 4, june: 5, july: 6, august: 7, september: 8, october: 9, november: 10, december: 11
            };

            const m = text.match(/(\d{1,2})\s*(?:st|nd|rd|th)?\s*([A-Za-z]+)/i);
            if (m) {
                const day = parseInt(m[1], 10);
                const monKey = m[2].toLowerCase();
                const mon = months[monKey.slice(0, 3)] ?? months[monKey];
                if (mon != null) {
                    const now = new Date();
                    const useYear = explicitYear || now.getFullYear();
                    let d = new Date(useYear, mon, day, 12, 0, 0, 0);
                    if (!explicitYear) {
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        if (d < today) d = new Date(useYear + 1, mon, day, 12, 0, 0, 0);
                    }
                    return d;
                }
            }

            const m2 = text.match(/([A-Za-z]+)\s*(\d{1,2})/i);
            if (m2) {
                const monKey = m2[1].toLowerCase();
                const mon = months[monKey.slice(0, 3)] ?? months[monKey];
                const day = parseInt(m2[2], 10);
                if (mon != null) {
                    const now = new Date();
                    const useYear = explicitYear || now.getFullYear();
                    let d = new Date(useYear, mon, day, 12, 0, 0, 0);
                    if (!explicitYear) {
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        if (d < today) d = new Date(useYear + 1, mon, day, 12, 0, 0, 0);
                    }
                    return d;
                }
            }

            return null;
        }

        function formatLocalDate(d) {
            if (!d || !(d instanceof Date)) return '';
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        function formatLocalDisplayDate(d) {
            if (!d || !(d instanceof Date)) return '';
            return d.toLocaleDateString();
        }

        function parseTimeSmart(text) {
            if (!text) return null;
            text = String(text).replace(/\./g, '').toLowerCase();
            const m = text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
            if (m) {
                let h = parseInt(m[1], 10);
                const mm = parseInt(m[2] || '0', 10);
                const ap = (m[3] || '').toLowerCase();
                if (ap === 'pm' && h < 12) h += 12;
                if (ap === 'am' && h === 12) h = 0;
                const d = new Date();
                d.setHours(h, mm, 0, 0);
                return d;
            }
            const wordNum = extractNumberFromText(text);
            if (wordNum != null) {
                let h = wordNum;
                if (text.includes('pm') || text.includes('evening') || text.includes('night')) h = (h % 12) + 12;
                const d = new Date(); d.setHours(h, 0, 0, 0); return d;
            }
            return null;
        }
        function formatLocalTime(d) {
            if (!d || !(d instanceof Date)) return '';
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        /* =========== Speech helpers =========== */
        let currentRecognition = null;
        function speakThenPause(text, lang = 'en-IN') {
            try { if (currentRecognition && typeof currentRecognition.abort === 'function') currentRecognition.abort(); } catch (e) { }
            return new Promise(resolve => {
                try {
                    const u = new SpeechSynthesisUtterance(String(text));
                    u.lang = lang;
                    u.onend = () => { setTimeout(resolve, 180); };
                    u.onerror = () => { setTimeout(resolve, 180); };
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(u);
                } catch (e) { setTimeout(resolve, 200); }
            });
        }

        function listenOnce({ lang = 'en-IN', interim = false, timeoutMs = 8000, maxAlternatives = 3 } = {}) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return Promise.resolve({ success: false, reason: 'unsupported' });
            return new Promise(resolve => {
                const r = new SR();
                currentRecognition = r;
                r.lang = lang; r.interimResults = interim; r.maxAlternatives = maxAlternatives;
                let gotFinal = false;
                let timer = null;
                r.onresult = (ev) => {
                    const idx = ev.resultIndex; const res = ev.results[idx];
                    let best = null;
                    for (let i = 0; i < res.length; i++) { const a = res[i]; if (!best || a.confidence > best.confidence) best = a; }
                    if (!best) return;
                    setTranscript((res.isFinal ? 'Final: ' : 'Interim: ') + best.transcript + (best.confidence != null ? ` (conf ${best.confidence.toFixed(2)})` : ''));
                    if (res.isFinal) {
                        gotFinal = true; clearTimeout(timer); currentRecognition = null;
                        try { r.stop(); } catch (e) { }
                        resolve({ success: true, transcript: best.transcript.trim(), confidence: best.confidence });
                    }
                };
                r.onerror = (e) => { clearTimeout(timer); currentRecognition = null; try { r.stop(); } catch (e) { }; resolve({ success: false, reason: e && e.error ? e.error : 'error' }); };
                r.onend = () => { if (!gotFinal) { clearTimeout(timer); currentRecognition = null; resolve({ success: false, reason: 'no-speech' }); } };
                try {
                    r.start();
                    timer = setTimeout(() => { try { r.stop(); } catch (e) { } }, timeoutMs);
                } catch (err) {
                    clearTimeout(timer); currentRecognition = null; resolve({ success: false, reason: 'start-failed' });
                }
            });
        }

        /* =========== Collected state =========== */
        const collected = { customerName: '', numberOfGuests: null, bookingDate: null, bookingTime: null, cuisinePreference: '', specialRequests: '' };

        /* =========== Field-specific capture flows =========== */
        async function captureGuests(lang) {
            const prompt = (lang.startsWith('hi')) ? "कितने लोग हैं? उदाहरण: दो मेहमान" : "How many guests? Please say '2 guests' or 'two guests'.";
            for (let attempt = 0; attempt < 3; attempt++) {
                await speakThenPause(prompt, lang);
                const r = await listenOnce({ lang, interim: false, timeoutMs: 7000 });
                if (!r.success) {
                    logStatus(`Guests: no speech (attempt ${attempt + 1})`);
                    continue;
                }
                const num = extractNumberFromText(r.transcript);
                if (num == null) { logStatus(`Guests: no number found in "${r.transcript}"`); continue; }
                const n = Math.max(1, Math.min(MAX_GUESTS, num));
                collected.numberOfGuests = n;
                setVal('numberOfGuests', n);
                document.getElementById('edit-numberOfGuests').value = n;
                return;
            }
            const typed = prompt("Enter number of guests (fallback):");
            if (typed) { const n = parseInt(typed, 10); if (!isNaN(n)) { collected.numberOfGuests = n; setVal('numberOfGuests', n); document.getElementById('edit-numberOfGuests').value = n; } }
        }

        async function askField(name, lang) {
            const prompts = {
                customerName: (lang.startsWith('hi') ? 'आपका नाम क्या है?' : 'What name should I use for the booking?'),
                bookingDate: (lang.startsWith('hi') ? 'कृपया तारीख बताएं, उदाहरण: 20 अगस्त' : 'Which date would you like to book? Say like July 21 or 21 August. You can also say the year, e.g., 20 August 2025.'),
                bookingTime: (lang.startsWith('hi') ? 'कृपया समय बताएं, उदाहरण: 6 बजे' : 'At what time should I reserve the table? Say like 6 pm or 6:00 p.m.'),
                cuisinePreference: (lang.startsWith('hi') ? 'पसंदीदा व्यंजन बताएं' : 'Any preferred cuisine?'),
                specialRequests: (lang.startsWith('hi') ? 'कोई विशेष अनुरोध?' : 'Any special requests (birthday, dietary restrictions)?')
            };
            await speakThenPause(prompts[name], lang);
            // for bookingTime we give more listen time
            const timeout = name === 'bookingTime' ? 10000 : 7000;
            const r = await listenOnce({ lang, interim: false, timeoutMs: timeout });
            if (!r.success) {
                logStatus(`${name}: voice capture failed (${r.reason}) — please type`);
                const v = prompt(`Enter ${name}:`);
                if (v == null) return;
                if (name === 'bookingDate') {
                    const d = parseDateSmart(v);
                    if (d) { collected[name] = formatLocalDate(d); setVal(name, formatLocalDisplayDate(d)); document.getElementById('edit-' + name).value = formatLocalDate(d); }
                    else { collected[name] = v; setVal(name, v); document.getElementById('edit-' + name).value = v; }
                    return;
                }
                if (name === 'bookingTime') {
                    const t = parseTimeSmart(v);
                    if (t) { collected[name] = formatLocalTime(t); setVal(name, formatLocalTime(t)); document.getElementById('edit-' + name).value = formatLocalTime(t); }
                    else { collected[name] = v; setVal(name, v); document.getElementById('edit-' + name).value = v; }
                    return;
                }
                collected[name] = v;
                setVal(name, v);
                document.getElementById('edit-' + name).value = v;
                return;
            }

            // success path
            if (name === 'bookingDate') {
                const d = parseDateSmart(r.transcript);
                if (d) {
                    collected[name] = formatLocalDate(d); // store YYYY-MM-DD (local)
                    setVal(name, formatLocalDisplayDate(d));
                    document.getElementById('edit-' + name).value = formatLocalDate(d);
                    logStatus(`Captured date ${formatLocalDisplayDate(d)}`);
                } else {
                    // raw fallback
                    collected[name] = r.transcript;
                    setVal(name, r.transcript);
                    document.getElementById('edit-' + name).value = r.transcript;
                    logStatus(`Captured raw date: ${r.transcript}`);
                }
                return;
            }

            if (name === 'bookingTime') {
                let t = parseTimeSmart(r.transcript);
                if (!t) {
                    const digits = r.transcript.match(/(\d{1,2})/);
                    if (digits) {
                        let h = parseInt(digits[1], 10);
                        if (r.transcript.toLowerCase().includes('evening') || r.transcript.toLowerCase().includes('pm')) h = (h % 12) + 12;
                        const dt = new Date(); dt.setHours(h, 0, 0, 0); t = dt;
                    }
                }
                if (t) {
                    collected[name] = formatLocalTime(t); // store HH:MM
                    setVal(name, formatLocalTime(t));
                    document.getElementById('edit-' + name).value = formatLocalTime(t);
                    logStatus(`Captured time ${formatLocalTime(t)}`);
                } else {
                    collected[name] = r.transcript;
                    setVal(name, r.transcript);
                    document.getElementById('edit-' + name).value = r.transcript;
                    logStatus(`Captured raw time: ${r.transcript}`);
                }
                return;
            }

            // generic fields
            collected[name] = r.transcript;
            setVal(name, r.transcript);
            document.getElementById('edit-' + name).value = r.transcript;
            logStatus(`Captured ${name}`);
        }

        /* =========== Main voice flow =========== */
        let running = false;
        document.getElementById('startBtn').addEventListener('click', startFlow);
        document.getElementById('stopBtn').addEventListener('click', () => {
            running = false;
            try { if (currentRecognition && typeof currentRecognition.abort === 'function') currentRecognition.abort(); } catch (e) { }
            window.speechSynthesis.cancel();
            logStatus('Voice flow stopped');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            try { if (currentRecognition && typeof currentRecognition.abort === 'function') currentRecognition.abort(); } catch (e) { }
            window.speechSynthesis.cancel();
            Object.assign(collected, { customerName: '', numberOfGuests: null, bookingDate: null, bookingTime: null, cuisinePreference: '', specialRequests: '' });
            ['customerName', 'numberOfGuests', 'bookingDate', 'bookingTime', 'cuisinePreference', 'specialRequests'].forEach(k => setVal(k, '—'));
            ['edit-customerName', 'edit-numberOfGuests', 'edit-bookingDate', 'edit-bookingTime', 'edit-cuisinePreference', 'edit-specialRequests'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            logStatus('Reset complete');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        });

        async function startFlow() {
            if (running) return;
            // ensure browser supports SR
            if (!(window.SpeechRecognition || window.webkitSpeechRecognition)) { alert('SpeechRecognition not supported — use Chrome.'); return; }
            running = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            logStatus('Voice flow started — speak when prompted');

            const lang = document.getElementById('langSelect').value || 'en-IN';
            try {
                await askField('customerName', lang);
                await captureGuests(lang);
                await askField('bookingDate', lang);
                await askField('bookingTime', lang);
                await askField('cuisinePreference', lang);
                await askField('specialRequests', lang);
                logStatus('Voice flow finished — review and Confirm & Preview');
            } catch (e) {
                console.error('Flow error', e);
                logStatus('Flow aborted: ' + (e.message || e));
            } finally {
                running = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        /* =========== Apply edits & preview/create =========== */
        document.getElementById('applyEdit').addEventListener('click', () => {
            collected.customerName = document.getElementById('edit-customerName').value || '';
            collected.numberOfGuests = parseInt(document.getElementById('edit-numberOfGuests').value, 10) || null;
            collected.bookingDate = document.getElementById('edit-bookingDate').value || null; // expected YYYY-MM-DD
            collected.bookingTime = document.getElementById('edit-bookingTime').value || null; // expected HH:MM or human
            collected.cuisinePreference = document.getElementById('edit-cuisinePreference').value || '';
            collected.specialRequests = document.getElementById('edit-specialRequests').value || '';
            setVal('customerName', collected.customerName || '—');
            setVal('numberOfGuests', collected.numberOfGuests || '—');
            setVal('bookingDate', collected.bookingDate ? (new Date(collected.bookingDate)).toLocaleDateString() : '—');
            setVal('bookingTime', collected.bookingTime || '—');
            setVal('cuisinePreference', collected.cuisinePreference || '—');
            setVal('specialRequests', collected.specialRequests || '—');
            logStatus('Edits applied');
        });

        /* Confirm & Preview */
        document.getElementById('confirmBtn').addEventListener('click', async () => {
            // prepare payload; leave bookingDate as YYYY-MM-DD if available, bookingTime as HH:MM
            const dateField = document.getElementById('edit-bookingDate').value || collected.bookingDate;
            const timeField = document.getElementById('edit-bookingTime').value || collected.bookingTime;

            const payload = {
                customerName: String(document.getElementById('edit-customerName').value || collected.customerName || '').trim(),
                numberOfGuests: (function (v) { v = v || document.getElementById('edit-numberOfGuests').value || collected.numberOfGuests; if (!v) return null; const n = parseInt(v, 10); if (!isNaN(n)) return n; const w = wordsToNumber(v); return w || null; })(),
                bookingDate: (function (v) {
                    if (!v) return null; // if it's YYYY-MM-DD keep; else parse
                    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
                    const d = parseDateSmart(v); return d ? formatLocalDate(d) : v;
                })(dateField),
                bookingTime: (function (v) { if (!v) return null; if (/^\d{2}:\d{2}$/.test(v)) return v; const t = parseTimeSmart(v); return t ? formatLocalTime(t) : v; })(timeField),
                cuisinePreference: String(document.getElementById('edit-cuisinePreference').value || collected.cuisinePreference || '').trim(),
                specialRequests: String(document.getElementById('edit-specialRequests').value || collected.specialRequests || '').trim(),
                location: null
            };

            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('previewJson').textContent = 'Calling preview...';
            logStatus('Calling preview API...');

            try {
                const res = await fetch((API_BASE || '') + '/api/bookings?preview=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                document.getElementById('previewJson').textContent = JSON.stringify(j, null, 2);
                if (j.success) {
                    logStatus('Preview returned — review seating suggestion');
                } else {
                    logStatus('Preview returned error: ' + (j.error || 'unknown'));
                }
            } catch (e) {
                document.getElementById('previewJson').textContent = 'Preview failed: ' + (e.message || e);
                logStatus('Preview call failed');
            }
        });

        /* Create booking (save) */
        document.getElementById('createBtn').addEventListener('click', async () => {
            // reuse last preview payload values from inputs
            const payload = {
                customerName: String(document.getElementById('edit-customerName').value || '').trim(),
                numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value, 10) || null,
                bookingDate: document.getElementById('edit-bookingDate').value || null,
                bookingTime: document.getElementById('edit-bookingTime').value || null,
                cuisinePreference: String(document.getElementById('edit-cuisinePreference').value || '').trim(),
                specialRequests: String(document.getElementById('edit-specialRequests').value || '').trim(),
                location: null
            };

            document.getElementById('previewJson').textContent = 'Creating booking...';
            logStatus('Creating booking...');

            try {
                const res = await fetch((API_BASE || '') + '/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                document.getElementById('previewJson').textContent = JSON.stringify(j, null, 2);
                if (j.success) {
                    logStatus('Booking created: ' + (j.booking && j.booking.bookingId ? j.booking.bookingId : 'ok'));
                } else {
                    logStatus('Create error: ' + (j.error || 'unknown'));
                }
            } catch (e) {
                document.getElementById('previewJson').textContent = 'Create failed: ' + (e.message || e);
                logStatus('Create call failed');
            }
        });

        /* =========== Init defaults =========== */
        document.getElementById('edit-customerName').value = '';
        document.getElementById('edit-numberOfGuests').value = '';
    </script>
</body>

</html>